<?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="sample">

<select id="boardContentSelect" parameterType="hashmap" resultType="hashmap">
 select * from tb_boardlist tbl left join tb_boardfield tb on tb.board_idx=tbl.board_idx where tbl.board_idx=#{board_idx};
</select>

<delete id="sample.fieldDelete" parameterType="hashmap">
 delete from tb_boardfield where board_idx=#{board_idx};
</delete>

<update id="sample.fieldChkUpdate" parameterType="hashmap">
UPDATE TB_BOARDLIST SET BOARD_FIELD_CHK='N' WHERE BOARD_IDX = #{board_idx};
</update>

<insert id="boardFieldInsert" parameterType="hashmap">
	<![CDATA[ INSERT INTO TB_BOARDFIELD (board_idx, board_field) VALUES ( #{BOARD_IDX}, #{input1}), ( #{BOARD_IDX}, #{input2}), ( #{BOARD_IDX}, #{input3}) ]]>
	</insert>

<select id="boardFieldSelect" parameterType="hashmap" resultType="hashmap">
<![CDATA[ SELECT * FROM TB_BOARDFIELD WHERE BOARD_IDX = #{BOARD_IDX}]]>
</select>

<update id = "boardFieldUpdate" parameterType="hashmap">
<![CDATA[ UPDATE TB_BOARDFIELD SET board_field = (case when field_idx = #{field_idx1} then #{input1}
											 when field_idx = #{field_idx2} then #{input2}
											 when field_idx = #{field_idx3} then #{input3} end)
											 where board_idx=#{BOARD_IDX}; ]]>
</update>

<select id="studyBoardManageDetail" parameterType="hashmap" resultType="hashmap"> 
<![CDATA[ SELECT * FROM TB_BOARDLIST WHERE BOARD_IDX = #{board_idx}]]>
	</select>

<delete id="sample.studyBoarddelete" parameterType="hashmap">
<![CDATA[ DELETE FROM TB_BOARDLIST WHERE BOARD_IDX = #{BOARD_IDX} ]]>
</delete>

<update id="sample.studyBoardUpdate" parameterType="hashmap"> 
<![CDATA[ UPDATE TB_BOARDLIST SET BOARD_NAME=#{BOARD_NAME}, BOARD_FIELD_CHK=#{BOARD_FIELD_CHK} WHERE BOARD_IDX = #{BOARD_IDX} ]]>
</update>

<select id="sample.openBoardList" resultType="hashmap" parameterType="hashmap" >
   <![CDATA[
 SELECT *
from (
	SELECT
           IDX,
           TITLE,
           HIT_CNT,
           CREA_DTM,
           TBL.*
       FROM
           TB_BOARD TB
       RIGHT JOIN TB_BOARDLIST TBL
       ON TB.board_idx = TBL.board_idx
        where del_gb = 'n'
      ) A 
 where A.board_idx=#{board_idx}
       ORDER BY 
           IDX desc;
   ]]>
</select>

<select id="sample.selectBoardManageList" resultType="hashmap" parameterType="hashmap" >
  SELECT * FROM TB_BOARDLIST
</select>

<select id="sample.writeList" resultType="hashmap" parameterType="hashmap" >
  SELECT * FROM TB_BOARDLIST WHERE BOARD_IDX = #{board_idx}
</select>

	<insert id="insertBoardManagement" parameterType="hashmap">
	<![CDATA[ INSERT INTO TB_BOARDLIST ( board_name, board_date) VALUES ( #{board_name}, current_timestamp) ]]>
	</insert>

	<select id="sample.selectBoardList" resultType="hashmap" parameterType="hashmap" >
   <![CDATA[
       SELECT
           (
               SELECT
                   COUNT(*) 
               FROM 
                   TB_BOARD
               WHERE 
                   DEL_GB = 'N'
           ) AS TOTAL_COUNT ,
           IDX,
           TITLE,
           HIT_CNT,
           CREA_DTM
       FROM
           TB_BOARD
       WHERE
           DEL_GB= 'N'
       ORDER BY 
           IDX DESC
       LIMIT #{START} , #{END} 
   ]]>
</select>


	<insert id="insertBoard" parameterType="hashmap"
		useGeneratedKeys="true" keyProperty="IDX">
	<![CDATA[ INSERT INTO TB_BOARD (BOARD_IDX, TITLE, CONTENTS, HIT_CNT, DEL_GB, CREA_DTM, CREA_ID ) VALUES (#{board_idx},  #{TITLE}, #{CONTENTS}, 0, 'N', current_timestamp, 'Admin') ]]>
	</insert>
	
	<insert id="insertField" parameterType="hashmap">
	 insert into tb_fielddata (idx, field_data, board_idx, field_idx) values ( #{IDX}, #{input1}, #{board_idx}, #{field_idx1}), (#{IDX}, #{input2}, #{board_idx}, #{field_idx2}), (#{IDX}, #{input3}, #{board_idx}, #{field_idx3})
	</insert>

	<update id="updateHitCnt" parameterType="hashmap">
	<![CDATA[ UPDATE TB_BOARD SET HIT_CNT = IFNULL(HIT_CNT, 0) + 1 WHERE IDX = #{IDX} ]]>
	</update>

	<select id="selectBoardDetail" parameterType="hashmap"
		resultType="hashmap"> <![CDATA[ SELECT BOARD_NAME, TB.BOARD_IDX, IDX, HIT_CNT, CREA_ID, CREA_DTM, TITLE, CONTENTS FROM TB_BOARD TB, TB_BOARDLIST TBL
		WHERE IDX = #{IDX} and TB.BOARD_IDX=TBL.BOARD_IDX]]>
	</select>

	<update id="updateBoard" parameterType="hashmap"> 
		<![CDATA[ UPDATE TB_BOARD SET TITLE = #{TITLE}, CONTENTS = #{CONTENTS} WHERE IDX = #{IDX} ]]>
	</update>
	
	<update id="updateField" parameterType="hashmap"> 
		<![CDATA[ UPDATE TB_FIELDDATA SET FIELD_DATA = (case when field_idx = #{field_idx1} then #{input1}
											 when field_idx = #{field_idx2} then #{input2}
											 when field_idx = #{field_idx3} then #{input3} end)
											  where board_idx=#{board_idx} and idx=#{IDX}]]>
	</update>

	<update id="deleteBoard" parameterType="hashmap">
		<![CDATA[ UPDATE TB_BOARD SET DEL_GB = 'Y' WHERE IDX = #{IDX} ]]>
	</update>

	<insert id="insertFile" parameterType="hashmap"> 
		<![CDATA[ INSERT INTO TB_FILE (BOARD_IDX, ORIGINAL_FILE_NAME, STORED_FILE_NAME, FILE_SIZE, CREA_ID ) VALUES (#{BOARD_IDX}, #{ORIGINAL_FILE_NAME}, #{STORED_FILE_NAME}, #{FILE_SIZE}, 'Admin' ) ]]>
	</insert>

	<select id="selectFileList" parameterType="hashmap" resultType="hashmap">
		 <![CDATA[ SELECT IDX, ORIGINAL_FILE_NAME, ROUND(FILE_SIZE/1024,1) AS FILE_SIZE FROM TB_FILE WHERE IDX = #{IDX} AND DEL_GB = 'N' ]]>
	</select>

	<update id="deleteFileList" parameterType="hashmap">
	<![CDATA[ UPDATE TB_FILE SET DEL_GB = 'Y' WHERE IDX = #{IDX} ]]>
	</update>
	
	<update id="updateFile" parameterType="hashmap">
	<![CDATA[ UPDATE TB_FILE SET DEL_GB = 'N' WHERE IDX = #{FILE_IDX} ]]>
	</update>
	
	<select id="selectFieldList" parameterType="hashmap" resultType="hashmap">
		 <![CDATA[ SELECT IDX, BF.BOARD_IDX, BOARD_FIELD, BF.FIELD_IDX, FIELD_DATA FROM TB_FIELDDATA FD, TB_BOARDFIELD BF WHERE IDX = #{IDX} AND BF.BOARD_IDX = FD.BOARD_IDX and BF.FIELD_IDX=FD.FIELD_IDX; ]]>
	</select>


</mapper>